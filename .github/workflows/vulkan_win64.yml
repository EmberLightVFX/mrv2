name: Vulkan Win64

on:
  push:
    branches-ignore:
      - main
    tags-ignore:
      - "**"
  workflow_dispatch:

jobs:
  ###################################
  #                                 #
  # FULL BUILDS                     #
  #                                 #
  ###################################
  windows-vulkan-full-build:
    runs-on: windows-2022

    defaults:
      run:
        shell: msys2 {0}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ runner.os }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Setup environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install Visual C++ Redistributable 2022
        run: |
          $vc_redist_url_2022 = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
          Invoke-WebRequest -Uri $vc_redist_url_2022 -OutFile vc_redist_2022.x64.exe
          Start-Process vc_redist_2022.x64.exe -ArgumentList "/install", "/quiet", "/norestart" -Wait
        shell: powershell

      # - name: Install specific MSVC toolset (in case build breaks)
      #   shell: powershell
      #   run: |
      #     Invoke-WebRequest `
      #     -Uri https://aka.ms/vs/17/release/vs_BuildTools.exe `
      #     -OutFile vs_BuildTools.exe

      #     Start-Process .\vs_BuildTools.exe `
      #     -ArgumentList `
      #     "--quiet", "--wait",
      #     "--add Microsoft.VisualStudio.Component.VC.Tools.x86.x64",
      #     "--includeRecommended",
      #     "--installPath C:\VS2022Custom" `
      #     -NoNewWindow -Wait- name: Activate MSVC

      # - name: Activate MSVC
      #   uses: ilammy/msvc-dev-cmd@v1
      #   with:
      #     path: 'C:\VS2022Custom'

      - name: Setup MSYS
        uses: msys2/setup-msys2@v2
        with:
          update: true
          path-type: inherit

      - name: Get machine name
        run: |
          echo "Machine name: $RUNNER_NAME"

      - name: Cache Vulkan SDK
        id: cache-vulkan-sdk
        uses: actions/cache@v4
        with:
          path: VulkanSDK-*
          key: ${{ runner.os }}-vulkan-sdk-1.3

      # Install Vulkan SDK
      - name: Install Vulkan SDK
        if: steps.cache-vulkan-sdk.outputs.cache-hit != 'true'
        env:
          BUILD_VULKAN: OFF
        run: |
          . ./etc/windows/install_vulkan.sh

      # Set Vulkan environment variables (always, even if cached)
      - name: Set Vulkan environment variables
        run: |
          # Debug: show current directory and contents
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la

          # Find Vulkan SDK installation in workspace
          VULKAN_DIR=$(find . -maxdepth 1 -type d -name "VulkanSDK-*" 2>/dev/null | head -1)

          if [ -z "$VULKAN_DIR" ]; then
            echo "Error: Vulkan SDK directory not found (VulkanSDK-*)"
            echo "Available directories:"
            ls -ld */ 2>/dev/null || echo "No directories found"
            exit 1
          fi

          if [ -d "$VULKAN_DIR" ]; then
            # Convert to absolute path
            VULKAN_DIR=$(cd "$VULKAN_DIR" && pwd)
            
            # Convert to Windows path for WINDOWS_VULKAN_SDK
            WINDOWS_PATH=$(cygpath -w "$VULKAN_DIR")
            
            echo "VULKAN_SDK=$VULKAN_DIR" >> $GITHUB_ENV
            echo "WINDOWS_VULKAN_SDK=$WINDOWS_PATH" >> $GITHUB_ENV
            echo "$VULKAN_DIR/bin" >> $GITHUB_PATH
            echo "VK_LAYER_PATH=$VULKAN_DIR/lib" >> $GITHUB_ENV
            echo "Vulkan SDK configured: $VULKAN_DIR"
            echo "Windows path: $WINDOWS_PATH"
          else
            echo "Error: Vulkan SDK directory exists but is not accessible: $VULKAN_DIR"
            exit 1
          fi

      - name: Install and Copy Vulkan Runtime
        shell: powershell
        run: |
          # 1. Run the Runtime Installer silently (/S)
          # This extracts vulkan-1.dll to C:\Windows\System32
          cd $Env:WINDOWS_VULKAN_SDK

          Write-Host "Installing Vulkan Runtime..."
          Start-Process -FilePath ".\Helpers\VulkanRT.exe" -ArgumentList "/S" -Wait

          # 2. Verify installation
          $systemDll = "C:\Windows\System32\vulkan-1.dll"
          if (Test-Path $systemDll) {
              Write-Host "SUCCESS: vulkan-1.dll found in System32."
              
              # 3. (Optional) Copy to your local Bin folder if your build expects it there
              Copy-Item -Path $systemDll -Destination ".\Bin\" -Force
              Write-Host "Copied vulkan-1.dll to local Bin folder."
          } else {
              Write-Error "FAILURE: vulkan-1.dll was not found in System32 after running installer."
              exit 1
          }

      # - name: Verify Vulkan
      #   run: ${VULKAN_SDK}/Bin/vulkaninfoSDK.exe

      - name: Setup environment
        run: mkdir -p ssh

      - name: Decode SSH key
        run: echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ssh/id_rsa
        shell: bash

      - name: Decode FLTK SSH key
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.FLTK_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Set permissions on SSH key
        shell: cmd
        run: |
          icacls "ssh\id_rsa" /inheritance:r /grant:r "%USERNAME%:R"

      - name: Set executable permissions
        run: |
          chmod +x ./*.sh ./bin/*.sh ./etc/*.sh ./bin/release/*.sh

      - name: Install MSYS2 Dependencies
        run: |
          pacman -S --noconfirm rsync

      - name: Build vmrv2
        env:
          GITHUB_OWNER: ""
          BUILD_PYTHON: ON
          MRV2_PYFLTK: ON
          MRV2_PYBIND11: ON
          MRV2_NETWORK: ON
          MRV2_PDF: ON
          TLRENDER_AV1: ON
          TLRENDER_EXR: ON
          TLRENDER_FFMPEG: ON
          TLRENDER_FFMPEG_MINIMAL: ON
          TLRENDER_GL: OFF
          TLRENDER_HAP: ON
          TLRENDER_JPEG: ON
          TLRENDER_NDI: OFF
          TLRENDER_NET: ON
          TLRENDER_OPENJPH: ON
          TLRENDER_RAW: ON
          TLRENDER_SGI: ON
          TLRENDER_STB: ON
          TLRENDER_SVTAV1: ON
          TLRENDER_TIFF: ON
          TLRENDER_USD: OFF
          TLRENDER_VPX: ON
          TLRENDER_YASM: ON

        run: |
          ./etc/runme_nolog.sh -v -t package -vk clean

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mrv2-vulkan-win64
          path: |
            paquetes/Windows-vulkan-amd64/Release/vmrv2-*.exe
            paquetes/Windows-vulkan-amd64/Release/vmrv2-*.zip
          if-no-files-found: warn
